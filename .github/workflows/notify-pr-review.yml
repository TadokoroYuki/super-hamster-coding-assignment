name: Notify PR Review Request

on:
  project_card:
    types: [moved]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ GitHub ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ‡ãƒãƒƒã‚°ï¼ˆãƒ­ã‚°ã‚’å‡ºåŠ›ï¼‰
      - name: Debug GitHub event payload
        run: |
          echo "GitHub event payload:"
          echo '${{ toJSON(github.event) }}'

      # 2ï¸âƒ£ å‰ã®ã‚«ãƒ©ãƒ åã‚’å–å¾—ï¼ˆ`project_id` ãŒ `undefined` ã®å ´åˆã«å¯¾å¿œï¼‰
      - name: Get previous column name
        id: prev_column
        uses: actions/github-script@v6
        with:
          script: |
            const projectCard = context.payload.project_card;

            // `project_card` ãŒ `undefined` ã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’å›é¿
            if (!projectCard) {
              console.log("Error: project_card is undefined");
              return "Unknown";
            }

            if (!projectCard.project_id) {
              console.log("Error: project_id is undefined");
              return "Unknown";
            }

            const prevColumnId = context.payload.changes?.column_id?.from || "Unknown";

            const columns = await github.rest.projects.listColumns({
              project_id: projectCard.project_id
            });

            const prevColumn = columns.data.find(c => c.id === prevColumnId);
            console.log("Previous column:", prevColumn ? prevColumn.name : "Unknown");
            return prevColumn ? prevColumn.name : "Unknown";

      # 3ï¸âƒ£ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®å‡ºåŠ›
      - name: Debug previous column name
        run: |
          echo "Previous column was: ${{ steps.prev_column.outputs.result }}"

      - name: Debug current column name
        run: |
          echo "Current column is: ${{ github.event.project_card.column_name }}"

      # 4ï¸âƒ£ ã€ŒTo Do â†’ In Progressã€ã®å ´åˆã®ã¿é€šçŸ¥ã‚’é€ä¿¡
      - name: Send Slack Notification
        if: steps.prev_column.outputs.result == 'To Do' && github.event.project_card.column_name == 'In Progress'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: "#your-review-channel"
          slack-message: "ğŸ” **ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ã¦ã„ã¾ã™ï¼**\nğŸ‘‰ PR: <${{ github.event.project_card.content_url }}>"
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
